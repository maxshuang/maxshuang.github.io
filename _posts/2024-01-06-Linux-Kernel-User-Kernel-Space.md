---
layout: post
title: Linux Kernel-From User Space To Kernel Space
subtitle: picture from https://www.pexels.com/search/wild%20animals/
author: maxshuang
categories: Linux-Kernel
banner:
    image: /assets/images/post/linux-kernel-user-kernel-space/pexels-lucas-pezeta.jpg
    opacity: 0.618
    background: "#000"
    height: "70vh"
    min_height: "38vh"
    heading_style: "font-size: 3.00em; font-weight: bold; text-decoration: underline"
    subheading_style: "color: gold"
tags: Linux-Kernel CPU
---

# 用户态和内核态切换
在之前的博客中，我们一直在介绍内存相关的话题，因为我觉得内存在一切逻辑和数据的载体，<font size=4>需要先搞清楚事物的存在形式，再讨论事物的组织形式和运作形式</font>。
所以我们从最核心的内核加载出发，介绍到物理内存页的管理和小内存分配，再到最后的内核给业务实体提供的抽象概念：进程线性地址空间。关于内存的一些核心概念我觉得大致上介绍完了，
注意实际实现还是很复杂的，需要考虑效率上的诸多细节。

这篇开始我们专注于 CPU 相关的概念，也就是事物是如何运行的。

## 用户态和内核态
这两个概念对于做后台开发的同学而言很熟悉，最常听见的说法是：要减少用户态到内核态的切换，避免不必要的开销。要说清楚这两个概念，我们也从几个问题开始：
1. 用户态和内核态是什么？
2. 用户态和内核态的存在形式是什么？
3. 用户态、内核态和内核的关系是什么？
4. 用户态切换内核态，内核态切换用户态都有哪些时机？

对于这几个问题，一个简单的回答是这样的：
1. 用户态是 CPU 在执行用户编写的逻辑和数据时的状态；内核态是 CPU 在执行内核代码和访问内核数据时的状态。
内核态可以访问一些硬件相关的操作，权限更高。
2. 用户态的存在形式是用户编写的逻辑和关联的数据；内核态的存在形式是内核代码和内核关联数据。
3. 用户态和内核关系不大，内核态时执行的是内核的代码和关联数据。
4. 用户在访问硬件资源时，比如读写文件，获取网络数据包等，依赖内核提供的系统调用完成从用户态到内核态的切换。中断也会导致用户态到内核态的切换。当内核态执行完成之后，返回用户态。

这个回答完全符合对于用户态和内核态的定义。但是我们需要知道为什么要这些概念，如何实现这些概念，以及用户态和内核态这两个概念的关系和交互。

我们把视角再往回拨一下。在内存篇中，我们知道了进程的分页机制，本质上除了为用户隔离物理内存的相关概念之外，还可以提高物理内存利用率，因为我不需要提前将具体某块大小的物理内存区间
提前分配给进程 A。每个进程都是以一样的进程页表机制获取物理内存，只有在访问线性地址页时发现没有分配物理内存页的情况下才能分配物理内存。
这里的关键问题是，查找页表和分配物理内存这个行为本身是高危的，要防止贪婪和恶意的用户编写代码操作这个行为，这样会和内核产生冲突，同时会影响其他进程实体的数据安全。相同的原理可以对应
到操作文件和网络设备，网络数据包是按时间顺序到达的，没有内核合理的分发，其他进程就可能获取到本进程的数据包，导致本进程数据包不完整。

所以这里就出现了需求，对于高危操作，所有进程都要委托给内核操作，并且内核代码和关联数据都要设置高权限，即使用户用汇编自己构造合法的线性地址，也没法访问对应的内核代码和操作内核数据。
这就是用户态和内核态概念出现的原因。Linux 内核是为多进程多用户服务了，内核除了要维护分时复用和进程线性空间这些抽象概念之外，还要考虑到独立实体之间的数据和自身核心操作的安全问题。
（这类有个表述上关联的小细节问题，就是在整个进程线性地址中，既有用户自己的代码区/数据区/堆区/栈区等等，还有内核映射的每个进程高线性地址区间[3G, 4)，所以用户是可以用汇编语言自己构造
访问位于内核所在的高线性区间的。虽然 CPU 此时权限不足无法访问内核线性区间，但是这样理解可以加深我们对于用户态和内核态在权限管理上的区别）。

除了给不同的线性区赋予权限之外，为了实现内核态，我们还需要知道一个问题：
* 怎么防止用户执行切换到高权限，从而访问高权限的数据？在一切都是机器码的前提下，既然系统调用可以切换到内核，为什么用户就不可以？

## 硬件相关的执行权限切换

## 用户态切换内核态时机

### 系统调用


### 中断


### 异常


#总结